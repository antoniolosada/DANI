#include <Arduino.h>
#include "LIDAR.h"
#include <Wire.h>
#include "DANI.h"
#include <Adafruit_VL53L0X.h>
#include <SoftwareServo.h>

Adafruit_VL53L0X lox = Adafruit_VL53L0X();

int Medidas_lidar[MAX_MEDIDAS_LIDAR+2];//Pos 0->pos servo, 1->v/h

void LOG_DEBUG(char *c1, long l1, long l2, float l3, float l4) ;
void AsignarServo(int iNumServo, int iValor, int iUnidad) ;

bool InicializarSensorLaser()
{
	if (!lox.begin())
	  {
		    LOG_DEBUG("Failed to detect and initialize sensor!",0,0,0,0);
		    return false;
	  }
	  return true;
}

int LeerMedidaSensorLaser()
{
  VL53L0X_RangingMeasurementData_t measure;
  int medida;
  lox.rangingTest(&measure, false); // si se pasa true como parametro, muestra por puerto serie datos de debug
  if (measure.RangeStatus != 4)
	  return  measure.RangeMilliMeter;
  else
	  return -1;
}

void LeerLinea(bool salida, int TipoLinea, int ValorServo)
{
	float salto, pos;
	int servo, pos_Reposo;
	if (TipoLinea == LINEA_VERTICAL)
	{
		salto = float(LIDAR_MAX_V - LIDAR_MIN_V)/MAX_MEDIDAS_LIDAR;
		servo = lidar_cabeceo;
		pos = LIDAR_MIN_V;
		pos_Reposo = POS_MEDIO_LIDAR_V;
	}
	else
	{
		salto = float(LIDAR_MAX_H - LIDAR_MIN_H)/MAX_MEDIDAS_LIDAR;
		servo = lidar_guinada;
		pos = LIDAR_MIN_H;
		pos_Reposo = POS_MEDIO_LIDAR_H;
	}
	Medidas_lidar[0] = TipoLinea;
	Medidas_lidar[1] = ValorServo;

	for (int i = 0; i < MAX_MEDIDAS_LIDAR; i++)
	{
		AsignarServo(servo, (int)pos, 0 );
		SoftwareServo::refresh();
		//Medidas_lidar[i+2] = LeerMedidaSensorLaser();
		pos += salto;
		delay(20);
	}
	AsignarServo(servo, pos_Reposo, 0 );

	if (salida)
	{
		Serial.print(TipoLinea==LINEA_VERTICAL?"L->":"l->");
		for (int i = 0; i < MAX_MEDIDAS_LIDAR+2; i++)
		{
			Serial.print(Medidas_lidar[i]);
			Serial.print(",");
		}
		Serial.println(";");
	}
}
