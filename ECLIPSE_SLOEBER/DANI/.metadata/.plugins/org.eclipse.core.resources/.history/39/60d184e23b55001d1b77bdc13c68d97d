#include <Arduino.h>
#include "LIDAR.h"
#include <Wire.h>
#include "DANI.h"
#include <VL53L0X.h>

VL53L0X sensor;

int Medidas_lidar[MAX_MEDIDAS_LIDAR+2];//Pos 0->pos servo, 1->v/h

void LOG_DEBUG(char *c1, long l1, long l2, float l3, float l4) ;
void AsignarServo(int iNumServo, int iValor, int iUnidad) ;

bool InicializarSensorLaser()
{
	  sensor.setTimeout(100);
	  if (!sensor.init())
	  {
		    LOG_DEBUG("Failed to detect and initialize sensor!",0,0,0,0);
		    return false;
	  }
	  else
		  sensor.setMeasurementTimingBudget(20000); //Alta velocidad 20ms/medida
	  return true;
}

int LeerMedidaSensorLaser()
{
	int medida = sensor.readRangeSingleMillimeters();
	if (sensor.timeoutOccurred())
		return -1;
	else
		return medida;
}

void LeerLinea(bool salida, int TipoLinea, int ValorServo)
{
	float salto, pos;
	int servo;
	if (TipoLinea == LINEA_VERTICAL)
	{
		salto = (LIDAR_MAX_V - LIDAR_MIN_V)/MAX_MEDIDAS_LIDAR;
		servo = lidar_cabeceo;
		pos = LIDAR_MIN_V;
	}
	else
	{
		salto = (LIDAR_MAX_H - LIDAR_MIN_H)/MAX_MEDIDAS_LIDAR;
		servo = lidar_guinada;
		pos = LIDAR_MIN_H;
	}
	Medidas_lidar[0] = TipoLinea;
	Medidas_lidar[1] = ValorServo;

	for (int i = 0; i < MAX_MEDIDAS_LIDAR; i++)
	{
		AsignarServo(servo, (int)pos, 0 );
		Medidas_lidar[i+2] = LeerMedidaSensorLaser();
		pos += salto;
	}
	if (salida)
	{
		Serial.print(TipoLinea==LINEA_VERTICAL?"L->":"l->");
		for (int i = 0; i < MAX_MEDIDAS_LIDAR+2; i++)
		{
			Serial.print(Medidas_lidar[i]);
			Serial.print(",");
		}
		Serial.println(";");
	}
}
